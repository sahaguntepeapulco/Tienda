<!doctype html>
<html lang="es">

<head>
  <title>Tienda</title>
  <!-- Required meta tags -->
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <!-- Bootstrap CSS v5.2.1 -->

  <link rel="stylesheet" href="/css/bootstrap.min.css" crossorigin="anonymous">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>


</head>

<body>
    <nav class="navbar navbar-expand navbar-dark bg-primary">
        <div class="nav navbar-nav">
            <a class="nav-item nav-link active" href="/productos">Productos</a>
            <a class="nav-item nav-link active" href="/nosotros">Nosotros</a>
        </div>
    </nav>
    <div class="container">
        <br/>
<div class="container">
    <div class="row">
        <div class="col-md-5">
            <div class="card">
                <div class="card-header">
                    Datos del Producto
                </div>
                <div class="card-body">

                    <form action="/admin/carrito" method="post" enctype="multipart/form-data">
                        <div class="mb-3">
                          <label for="txtNombre" class="form-label">Nombre:</label>
                          
                          <select class="form-control form-control-sm" name="txtNombre" id="txtNombre">
                            <!-- Las opciones serán llenadas dinámicamente por JavaScript -->
                        </select>
                        
                          
                          
                              
                              <script>
                                
                                  $(document).ready(function(){
    // Llenar el dropdown al cargar la página
    $.ajax({
        url: '/obtener_nombres_productos',
        method: 'GET',
        success: function(data){
            var options = '';
            data.forEach(function(nombre){
                options += '<option value="' + nombre + '">' + nombre + '</option>';
            });
            $("#txtNombre").html(options);

            if(data.length > 0) {
                // Obtiene el precio del primer producto al cargar
                obtenerPrecioProducto(data[0]);
            }
        }
    });

    // Cuando cambia el producto seleccionado
    $("#txtNombre").on('change', function(){
        var nombreSeleccionado = $(this).val();
        obtenerPrecioProducto(nombreSeleccionado);
    });

    // Cuando cambias el valor en txtCantidad
    $("#txtCantidad").on('input', function() {
        let precioBase = parseFloat($("#txtPrecio").attr("data-precio-base")) || 0;
        let cantidad = parseFloat($(this).val()) || 0;
        let total = precioBase * cantidad;
        $("#txtPrecio").val(total.toFixed(2)); // Actualiza el valor total
    });
});

function obtenerPrecioProducto(nombreSeleccionado) {
    $.ajax({
        url: '/buscar_producto',
        method: 'POST',
        data: { 'query': nombreSeleccionado },
        success: function(data){
            if(data.length === 1 && data[0].nombre === nombreSeleccionado) {
                $("#txtPrecio").val(data[0].precio); 
                $("#txtPrecio").attr("data-precio-base", data[0].precio);  // Guarda el precio base
            } else {
                $("#txtPrecio").val(''); 
            }
        }
    });
}
function actualizarTotal() {
    var total = 0;
    // Suma todos los precios en la tabla
    $('table tbody tr').each(function() {
        var precio = parseFloat($(this).find('td:eq(4)').text().replace('$', '')); // :eq(4) selecciona la quinta columna, recordando que las listas basadas en 0 empiezan en 0
        if (!isNaN(precio)) total += precio; // Suma solo si el valor es un número
    });
    $('#totalPriceCell').text('$' + total.toFixed(2)); // Muestra el total con 2 decimales
}
// ... dentro de tu llamada AJAX que añade un producto...
success: function(data){
    // Asumiendo que data contiene el producto añadido...
    // Añade el producto a la tabla (esto es solo un ejemplo básico, puedes adaptarlo según tus necesidades)
    var newRow = `
        <tr>
            <td>${data.id}</td>
            <td>${data.nombre}</td>
            <td>${data.cantidad}</td>
            <td>${data.fecha}</td>
            <td>${data.precio}</td>
            <td>...</td> <!-- Aquí iría tu formulario de eliminación y botón -->
        </tr>
    `;
    $('table tbody').append(newRow);
    actualizarTotal();
}
// ... dentro de tu llamada AJAX que elimina un producto...
success: function(data){
    // Asumiendo que data contiene el ID del producto eliminado...
    $(`table tbody tr:contains("${data.id}")`).remove(); // Esto elimina la fila que contiene el ID del producto. Es un selector simple, pero es posible que necesites algo más sofisticado si tienes IDs similares en otras partes de tu tabla.
    actualizarTotal();
}
$(document).ready(function() {
    actualizarTotal();
    // ... el resto de tu código ...
});


                            </script>
                                

                        </div>
                        
                        <div class="mb-3">
                            <label for="txtCantidad" class="form-label">Cantidad:</label>
                            <input type="number" step="0.01" min="0" class="form-control form-control-sm" name="txtCantidad" id="txtCantidad" aria-describedby="helpId" placeholder="Escribe la cantidad del Producto"></div>
                          
                          
                          <div class="mb-3">
                            <label for="txtFecha" class="form-label">Fecha:</label>
                            <input type="date"
                              class="form-control form-control-sm" name="txtFecha" id="txtFecha" aria-describedby="helpId" placeholder="Selecciona la fecha del Producto">
                          </div> 

                          <div class="mb-3">
                            <label for="txtPrecio" class="form-label">Precio:</label>
                            <input type="text" class="form-control form-control-sm" name="txtPrecio" id="txtPrecio" aria-describedby="helpId" placeholder="Precio del Producto" readonly>

                        </div>
                         

                        <button type="submit" class="btn btn-primary">Añadir</button>  


                    </form>
                    

                </div>
                <div class="card-footer text-muted">
                    
                </div>
            </div>
        </div>
        <div class="col-md-7">

            <div class="table-responsive">
                <table class="table table-bordered">
                    <thead>
                        <tr>
                            <th scope="col">ID</th>
                            <th scope="col">Nombre</th>
                            <th scope="col">Cantidad</th>
                            <th scope="col">Fecha</th>
                            <th scope="col">Precio</th>
                            <th scope="col">Borrar</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for compra in compras %}
                        <tr class="">
                            <td>{{ compra[0] }}</td>
                            <td>{{ compra[1] }}</td>
                            <td>{{ compra[2] }}</td>
                            <td>{{ compra[3] }}</td>
                            <td>{{ compra[4] }}</td>


                            <td>
                                <form action="/admin/carrito/borrar" method="post">
                                    <input value="{{ compra[0] }}" type="hidden" name="txtID" id="txtID">
                                    <button type="submit" class="btn btn-danger">Eliminar</button>
                                </form>
                            </td>
                        </tr>
                        {% endfor %}
                        <tfoot>
                            <tr>
                                <td colspan="4" class="text-right"><strong>Total:</strong></td>
                                <td id="totalPriceCell">$0.00</td>
                                <td></td>
                            </tr>
                        </tfoot>
                        
                    </tbody>
                </table>
                
                <div class="mt-3 d-flex justify-content-between">
                    <form action="/admin/carrito/enviar-whatsapp" method="post">
                        <button type="submit" class="btn btn-success">Enviar</button>
                    </form>
                    
                </div>
                
                
            </div>                        
        </div>        
    </div>
</div>
    
{% include 'admin/pie.html' %} 
